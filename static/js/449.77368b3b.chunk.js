"use strict";(self.webpackChunk_kne_components_speech_text=self.webpackChunk_kne_components_speech_text||[]).push([[449,830],{1830:(e,a,t)=>{t.r(a),t.d(a,{default:()=>c,speechTextRealTime:()=>d});var n=t(8494),s=t.n(n),o=t(195),r=t.n(o),i=(t(458),t(3252));const c=async e=>{const{url:a,sampleRate:t,bitRate:n,options:o,onComplete:i}=Object.assign({sampleRate:16e3,bitRate:16},{},e),c=r()({type:"wav",sampleRate:t,bitRate:n});return{start:async()=>(await new Promise(((e,a)=>{c.open(e,a)})),c.start(),{record:c}),stop:async()=>{const e=await new Promise(((e,a)=>{c.stop((a=>{e(new File([a],"audio.wav",{type:"audio/wav"}))}),a)}));return c.close(),i&&i({file:e}),a&&await s().postForm(a,{file:e},o)}}},p=()=>(0,i.A)().replace(/-/g,""),d=async e=>{const{url:a,options:t,getToken:n,getGatewayUrl:o,sampleRate:r,onError:i,onChange:c,onComplete:d}=Object.assign({},{getGatewayUrl:e=>{let{token:a}=e;return`wss://nls-gateway-cn-shanghai.aliyuncs.com/ws/v1?token=${a}`},onChange:e=>{let{message:a}=e;console.log(a)},onError:()=>{},sampleRate:16e3},e),l=p();let m=null;return{start:async()=>{const{token:e,appKey:a}=await n(),t=p(),s=new WebSocket(o({token:e})),d=[],u=[];let w="";await new Promise((e=>{s.addEventListener("open",(()=>{console.log("socket\u94fe\u63a5\u6210\u529f"),s.send(JSON.stringify({header:{message_id:t,task_id:l,namespace:"SpeechTranscriber",name:"StartTranscription",appkey:a},payload:{format:"pcm",sample_rate:16e3,max_sentence_silence:200,enable_intermediate_result:!0,enable_punctuation_prediction:!0,enable_inverse_text_normalization:!0}}))})),s.addEventListener("message",(a=>{const t=JSON.parse(a.data);"TranscriptionStarted"===t.header.name&&e(),"TranscriptionResultChanged"!==t.header.name&&"SentenceEnd"!==t.header.name||(Object.assign(d,{[t.payload.index]:t.payload.result}),w=Object.keys(d).sort(((e,a)=>e-a)).map((e=>d[e])).join(""),c&&c({payload:t.payload,chunks:d,message:w}))}))}));const g=await window.navigator.mediaDevices.getUserMedia({audio:!0}).catch((e=>{throw console.log("\u83b7\u53d6\u9ea6\u514b\u98ce\u6743\u9650\u5931\u8d25\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5"),i("\u83b7\u53d6\u9ea6\u514b\u98ce\u6743\u9650\u5931\u8d25\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5","NO_MICROPHONE_PERMISSION",e),e})),h=new window.MediaRecorder(g);h.start(1e3);const k=new(window.AudioContext||window.webkitAudioContext)({sampleRate:r}),y=k.createMediaStreamSource(g),_=k.createScriptProcessor(2048,1,1);_.onaudioprocess=function(e){const a=e.inputBuffer.getChannelData(0),t=new Int16Array(a.length);for(let n=0;n<a.length;++n)t[n]=32767*Math.max(-1,Math.min(1,a[n]));s.send(t.buffer)},y.connect(_),_.connect(k.destination);const b=e=>{u.push(e.data)};return h.addEventListener("dataavailable",b),m={ws:s,stream:g,taskId:l,messageId:t,scriptProcessor:_,audioInput:y,audioContext:k,appKey:a,resultChunks:d,chunks:u,message:w,destroy:()=>{s.send(JSON.stringify({header:{message_id:t,task_id:l,namespace:"SpeechTranscriber",name:"StopTranscription",appkey:a}})),h.removeEventListener("dataavailable",b),s.close(),_.disconnect(),y.disconnect(),k.close();(g.getTracks&&g.getTracks()||g.audioTracks||[]).forEach((e=>{e.stop&&e.stop()})),g.stop&&g.stop()}},m},stop:async()=>{if(!m)return;const{taskId:e,messageId:n,chunks:o,destroy:r,message:i}=m,c=await new Promise(((a,t)=>{const s=new File(o,`${e}.wav`,{type:"audio/wav"});d&&d({file:s,taskId:e,messageId:n,message:i,chunks:o}),r(),m=null,a(s)}));return a&&await s().postForm(a,{file:c},t)}}}}}]);
//# sourceMappingURL=449.77368b3b.chunk.js.map