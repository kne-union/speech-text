"use strict";(self.webpackChunk_kne_components_speech_text=self.webpackChunk_kne_components_speech_text||[]).push([[449,830],{1830:(e,t,a)=>{a.r(t),a.d(t,{default:()=>c,realtimeXfyun:()=>g,speechTextRealTime:()=>l});var n=a(8494),r=a.n(n),o=a(195),s=a.n(o),i=(a(458),a(3252));const c=async e=>{const{url:t,sampleRate:a,bitRate:n,options:o,onComplete:i}=Object.assign({sampleRate:16e3,bitRate:16},{},e),c=s()({type:"wav",sampleRate:a,bitRate:n});return{start:async()=>(await new Promise(((e,t)=>{c.open(e,t)})),c.start(),{record:c}),stop:async()=>{const e=await new Promise(((e,t)=>{c.stop((t=>{e(new File([t],"audio.wav",{type:"audio/wav"}))}),t)}));return c.close(),i&&i({file:e}),t&&await r().postForm(t,{file:e},o)}}},u=()=>(0,i.A)().replace(/-/g,""),l=async e=>{const{url:t,options:a,getToken:n,getGatewayUrl:o,sampleRate:s,frameSize:i,onError:c,onChange:l,onComplete:d}=Object.assign({},{getGatewayUrl:e=>{let{token:t}=e;return`wss://nls-gateway-cn-shanghai.aliyuncs.com/ws/v1?token=${t}`},onChange:e=>{let{message:t}=e;console.log(t)},onError:()=>{},sampleRate:16e3,frameSize:1280},e),p=u();let m=null;return{start:async()=>{const{token:e,appKey:t}=await n(),a=u(),r=new WebSocket(o({token:e})),d=[],f=[];let w="";await new Promise((e=>{r.addEventListener("open",(()=>{console.log("socket\u94fe\u63a5\u6210\u529f"),r.send(JSON.stringify({header:{message_id:a,task_id:p,namespace:"SpeechTranscriber",name:"StartTranscription",appkey:t},payload:{format:"pcm",sample_rate:16e3,max_sentence_silence:200,enable_intermediate_result:!0,enable_punctuation_prediction:!0,enable_inverse_text_normalization:!0}}))})),r.addEventListener("message",(t=>{const a=JSON.parse(t.data);"TranscriptionStarted"===a.header.name&&e(),"TranscriptionResultChanged"!==a.header.name&&"SentenceEnd"!==a.header.name||(Object.assign(d,{[a.payload.index]:a.payload.result}),w=Object.keys(d).sort(((e,t)=>e-t)).map((e=>d[e])).join(""),l&&l({payload:a.payload,chunks:d,message:w}))}))}));const h=await window.navigator.mediaDevices.getUserMedia({audio:!0}).catch((e=>{throw console.log("\u83b7\u53d6\u9ea6\u514b\u98ce\u6743\u9650\u5931\u8d25\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5"),c("\u83b7\u53d6\u9ea6\u514b\u98ce\u6743\u9650\u5931\u8d25\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5","NO_MICROPHONE_PERMISSION",e),e})),g=new window.MediaRecorder(h,{mimeType:"audio/wav"});g.start(i);const y=new(window.AudioContext||window.webkitAudioContext)({sampleRate:s}),v=y.createMediaStreamSource(h),k=y.createScriptProcessor(2048,1,1);k.onaudioprocess=function(e){const t=e.inputBuffer.getChannelData(0),a=new Int16Array(t.length);for(let n=0;n<t.length;++n)a[n]=32767*Math.max(-1,Math.min(1,t[n]));r.send(a.buffer)},v.connect(k),k.connect(y.destination);const S=e=>{f.push(e.data)};return g.addEventListener("dataavailable",S),m={ws:r,stream:h,taskId:p,messageId:a,scriptProcessor:k,audioInput:v,audioContext:y,appKey:t,resultChunks:d,chunks:f,message:w,destroy:()=>{r.send(JSON.stringify({header:{message_id:a,task_id:p,namespace:"SpeechTranscriber",name:"StopTranscription",appkey:t}})),g.removeEventListener("dataavailable",S),r.close(),k.disconnect(),v.disconnect(),y.close();(h.getTracks&&h.getTracks()||h.audioTracks||[]).forEach((e=>{e.stop&&e.stop()})),h.stop&&h.stop()}},m},stop:async()=>{if(!m)return;const{taskId:e,messageId:n,chunks:o,destroy:s,message:i}=m,c=await new Promise(((t,a)=>{const r=new File(o,`${e}.wav`,{type:"audio/wav"});d&&d({file:r,taskId:e,messageId:n,message:i,chunks:o}),s(),m=null,t(r)}));return t&&await r().postForm(t,{file:c},a)}}};function d(e,t,a,n){return new(a||(a=Promise))((function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function i(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,i)}c((n=n.apply(e,t||[])).next())}))}function p(e,t){var a,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(i){return function(c){return function(i){if(a)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(s=0)),s;)try{if(a=1,n&&(r=2&i[0]?n.return:i[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,i[1])).done)return r;switch(n=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{a=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}var m=!AudioWorkletNode;function f(){var e;return(null===(e=navigator.mediaDevices)||void 0===e?void 0:e.getUserMedia)?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}):navigator.getUserMedia?new Promise((function(e,t){navigator.getUserMedia({audio:!0,video:!1},(function(t){e(t)}),(function(e){t(e)}))})):Promise.reject(new Error("\u4e0d\u652f\u6301\u5f55\u97f3"))}function w(e,t){return d(this,void 0,void 0,(function(){return p(this,(function(a){switch(a.label){case 0:return m?[4,e.audioWorklet.addModule("".concat(t,"/processor.worklet.js"))]:[3,2];case 1:return a.sent(),[2,new AudioWorkletNode(e,"processor-worklet")];case 2:return[4,new Worker("".concat(t,"/processor.worker.js"))];case 3:return[2,{port:a.sent()}]}}))}))}var h=function(){function e(e){this.processorPath=e,this.audioBuffers=[]}return e.prototype.start=function(e){var t,a=e.sampleRate,n=e.frameSize,r=e.arrayBufferType;return d(this,void 0,void 0,(function(){var e,o,s,i,c,u;return p(this,(function(l){switch(l.label){case 0:return(e=this).audioBuffers=[],[4,f()];case 1:return o=l.sent(),this.audioTracks=o.getAudioTracks(),s=function(e,t){var a;try{(a=new(window.AudioContext||window.webkitAudioContext)({sampleRate:t})).createMediaStreamSource(e)}catch(t){(a=new(window.AudioContext||window.webkitAudioContext)).createMediaStreamSource(e)}return a}(o,a),this.audioContext=s,s.createMediaStreamSource(o),i=s.createMediaStreamSource(o),[4,w(s,this.processorPath)];case 2:return c=l.sent(),this.audioWorklet=c,c.port.postMessage({type:"init",data:{frameSize:n,toSampleRate:a||s.sampleRate,fromSampleRate:s.sampleRate,arrayBufferType:r||"short16"}}),c.port.onmessage=function(t){n&&e.onFrameRecorded&&e.onFrameRecorded(t.data),e.onStop&&(t.data.frameBuffer&&e.audioBuffers.push(t.data.frameBuffer),t.data.isLastFrame&&!m&&(null==c?void 0:c.port).terminate(),t.data.isLastFrame&&e.onStop(e.audioBuffers))},m?i.connect(c):((u=s.createScriptProcessor(0,1,1)).onaudioprocess=function(e){c.port.postMessage({type:"message",data:e.inputBuffer.getChannelData(0)})},i.connect(u),u.connect(s.destination)),s.resume(),null===(t=this.onStart)||void 0===t||t.call(this),[2]}}))}))},e.prototype.stop=function(){var e,t,a;null===(e=this.audioWorklet)||void 0===e||e.port.postMessage({type:"stop"}),null===(t=this.audioTracks)||void 0===t||t[0].stop(),null===(a=this.audioContext)||void 0===a||a.suspend()},e}();const g=async e=>{const{url:t,workerUrl:a,options:n,getToken:r,getGatewayUrl:o,onError:s,onChange:i,onProgress:c,onComplete:u,sampleRate:l,frameSize:d}=Object.assign({},{getGatewayUrl:e=>`wss://rtasr.xfyun.cn/v1/ws?${new URLSearchParams(e).toString()}`,onChange:e=>{let{message:t}=e;console.log(t)},onProgress:()=>{},onError:()=>{},sampleRate:16e3,frameSize:1280},e);let p=null;return{start:async e=>{const t=new h(a),n=new Promise((e=>{t.onStart=()=>{e()}})),m=Object.assign({},e,await r()),f=o(m),w=new WebSocket(f);let g="",y=[],v="0";return w.onopen=e=>{t.start({sampleRate:l,frameSize:d})},w.onerror=e=>{console.error(e),t.stop(),s("\u8fde\u63a5\u670d\u52a1\u5668\u5931\u8d25","WS_SERVER_ERROR",e)},w.onclose=()=>{t.stop()},w.onmessage=e=>{let t=JSON.parse(e.data);if(console.log(t),"error"===t.action&&(console.log(t),s(t.desc,"XFYUN_SERVER_ERROR",t)),"result"!==t.action)return;const a=JSON.parse(t.data);let n="";if(a.cn.st.rt.forEach((e=>{e.ws.forEach((e=>{e.cw.forEach((e=>{"0"!==e.rl&&(v=e.rl),n+=e.w}))}))})),"0"===a.cn.st.type){const e=new Date;g+=n,"0"!==v&&(Array.isArray(y[v-1])||(y[v-1]=[]),y[v-1].push({type:v,message:n,time:e})),c&&c({type:v,message:n,time:e}),n=""}i&&i({message:g,messageList:y,temp:n,type:v})},t.onFrameRecorded=e=>{let{isLastFrame:t,frameBuffer:a}=e;w.readyState===w.OPEN&&(w.send(new Int8Array(a)),t&&w.send('{"end": true}'))},t.onStop=e=>{u&&u({audioBuffers:e})},p={ws:w,recorder:t,params:m},await n,p},stop:async()=>{if(!p)return;const{recorder:e}=p;e.stop()}}}}}]);
//# sourceMappingURL=830.b5166109.chunk.js.map